"use client"

import { useEffect, useState } from "react";
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell } from "recharts";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import { AlertTriangle, Users, Download, DollarSign, Database } from "lucide-react";
import { getDataExploitationStats, type DataExploitationStats } from "@/lib/data-sources";

export default function DataExploitationVisualization() {
  const [stats, setStats] = useState<DataExploitationStats | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    async function fetchData() {
      try {
        const data = await getDataExploitationStats();
        setStats(data);
      } catch (error) {
        console.error('Failed to load data exploitation stats:', error);
      } finally {
        setLoading(false);
      }
    }
    fetchData();
  }, []);

  if (loading || !stats) {
    return <div className="animate-pulse space-y-4">Loading...</div>;
  }

  // Company-specific colors for better readability
  const companyColors: Record<string, string> = {
    'OpenAI': '#10b981',    // Emerald green
    'Meta': '#3b82f6',      // Blue  
    'Google': '#f59e0b',    // Amber
    'Microsoft': '#8b5cf6', // Violet
    'Anthropic': '#ef4444'  // Red
  };

  const compensationData = stats.datasetSizes.map(item => {
    // Convert TB to GB for consistency
    const sizeStr = item.size;
    let sizeInGB = parseFloat(sizeStr.replace(/[^0-9.]/g, ''));
    if (sizeStr.includes('TB')) {
      sizeInGB = sizeInGB * 1000; // Convert TB to GB
    }
    
    return {
      company: item.company,
      dataSize: sizeInGB,
      compensation: item.cost,
      formattedSize: item.size,
      color: companyColors[item.company] || '#6b7280'
    };
  });


  return (
    <div className="space-y-8">
      {/* Key Impact Statistics */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <Card className="bg-gradient-to-br from-destructive/10 to-destructive/5 border-destructive/20">
          <CardHeader className="pb-2">
            <div className="flex items-center justify-between">
              <CardTitle className="text-sm font-medium">Web Scraping Volume</CardTitle>
              <Download className="h-4 w-4 text-destructive" />
            </div>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold text-destructive">
              {(stats.webScrapingVolume / 1000000000000).toFixed(0)}TB+
            </div>
            <p className="text-xs text-muted-foreground mt-1">
              Data scraped without permission
            </p>
            <Badge variant="destructive" className="mt-2 text-xs">
              Unconsented use
            </Badge>
          </CardContent>
        </Card>

        <Card className="bg-gradient-to-br from-orange-500/10 to-orange-500/5 border-orange-500/20">
          <CardHeader className="pb-2">
            <div className="flex items-center justify-between">
              <CardTitle className="text-sm font-medium">Creators Affected</CardTitle>
              <Users className="h-4 w-4 text-orange-500" />
            </div>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold text-orange-500">
              {(stats.creatorsAffected / 1000000000).toFixed(1)}B+
            </div>
            <p className="text-xs text-muted-foreground mt-1">
              Artists, writers, developers impacted
            </p>
            <Badge variant="secondary" className="mt-2 text-xs">
              No attribution given
            </Badge>
          </CardContent>
        </Card>

        <Card className="bg-gradient-to-br from-green-500/10 to-green-500/5 border-green-500/20">
          <CardHeader className="pb-2">
            <div className="flex items-center justify-between">
              <CardTitle className="text-sm font-medium">Total Compensation</CardTitle>
              <DollarSign className="h-4 w-4 text-green-500" />
            </div>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold text-green-500">
              $0
            </div>
            <p className="text-xs text-muted-foreground mt-1">
              Paid to content creators
            </p>
            <Badge variant="destructive" className="mt-2 text-xs">
              Zero compensation
            </Badge>
          </CardContent>
        </Card>
      </div>

      {/* Company Dataset Sizes */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Database className="h-5 w-5 text-primary" />
            Training Dataset Sizes by Company
          </CardTitle>
          <CardDescription>
            Massive datasets built from unconsented scraping of human-created content
          </CardDescription>
        </CardHeader>
        <CardContent>
          <ResponsiveContainer width="100%" height={450}>
            <BarChart data={compensationData} margin={{ top: 10, right: 20, left: 30, bottom: 60 }}>
              <CartesianGrid strokeDasharray="3 3" className="stroke-muted" />
              <XAxis 
                dataKey="company" 
                className="text-muted-foreground"
                angle={-45}
                textAnchor="end"
                height={60}
                tick={{ fontSize: 12 }}
              />
              <YAxis 
                className="text-muted-foreground"
                label={{ value: 'Dataset Size (GB)', angle: -90, position: 'insideLeft', style: { fontSize: 12 } }}
                tick={{ fontSize: 12 }}
              />
              <Tooltip 
                contentStyle={{
                  backgroundColor: 'rgba(255, 255, 255, 0.95)',
                  border: '1px solid #e5e7eb',
                  borderRadius: '8px',
                  boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
                  padding: '12px'
                }}
                labelStyle={{
                  color: '#111827',
                  fontWeight: 'bold',
                  marginBottom: '4px'
                }}
                formatter={(value: number) => [
                  `${value.toLocaleString()} GB`,
                  'Dataset Size'
                ]}
                cursor={{ fill: 'rgba(0, 0, 0, 0.05)' }}
              />
              <Bar 
                dataKey="dataSize" 
                name="Dataset Size"
                radius={[8, 8, 0, 0]}
                maxBarSize={120}
              >
                {compensationData.map((entry, index) => (
                  <Cell key={`cell-${index}`} fill={entry.color} />
                ))}
              </Bar>
            </BarChart>
          </ResponsiveContainer>
          
          {/* Compensation Status - Redesigned for Impact */}
          <div className="mt-8 p-6 bg-gradient-to-r from-destructive/10 via-destructive/5 to-transparent rounded-lg border border-destructive/20">
            <div className="flex items-center gap-3 mb-4">
              <div className="h-10 w-10 rounded-full bg-destructive/20 flex items-center justify-center">
                <AlertTriangle className="h-5 w-5 text-destructive" />
              </div>
              <div>
                <h4 className="font-bold text-lg text-destructive">The $0 Compensation Reality</h4>
                <p className="text-sm text-muted-foreground">Billions in data extracted, zero dollars returned</p>
              </div>
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
              {/* Left side - Data Taken */}
              <div className="space-y-3">
                <h5 className="font-semibold text-sm text-foreground mb-3">Data Scraped Without Permission</h5>
                {compensationData.map((item, index) => (
                  <div key={index} className="flex items-center gap-3">
                    <div 
                      className="w-3 h-3 rounded-full flex-shrink-0" 
                      style={{ backgroundColor: item.color }}
                    />
                    <span className="text-sm font-medium flex-1">{item.company}</span>
                    <span className="text-sm font-bold" style={{ color: item.color }}>
                      {item.formattedSize}
                    </span>
                  </div>
                ))}
                <div className="pt-3 mt-3 border-t">
                  <div className="flex justify-between items-center">
                    <span className="text-sm font-semibold">Total Data Extracted</span>
                    <span className="text-lg font-bold text-destructive">~5.7TB</span>
                  </div>
                </div>
              </div>
              
              {/* Right side - Compensation Paid */}
              <div className="space-y-3">
                <h5 className="font-semibold text-sm text-foreground mb-3">Compensation to Creators</h5>
                {compensationData.map((item, index) => (
                  <div key={index} className="flex items-center gap-3">
                    <div className="w-3 h-3 rounded-full bg-gray-300 flex-shrink-0" />
                    <span className="text-sm font-medium flex-1 text-muted-foreground">{item.company}</span>
                    <Badge variant="destructive" className="text-xs">$0</Badge>
                  </div>
                ))}
                <div className="pt-3 mt-3 border-t">
                  <div className="flex justify-between items-center">
                    <span className="text-sm font-semibold">Total Paid to Creators</span>
                    <span className="text-2xl font-bold text-destructive">$0</span>
                  </div>
                </div>
              </div>
            </div>
            
            <div className="mt-6 p-3 bg-destructive/20 rounded text-center">
              <p className="text-sm font-medium text-destructive">
                Every AI company has built their models on human creativity without compensation
              </p>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Impact Analysis */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <Card>
          <CardHeader>
            <CardTitle>Creator Impact Analysis</CardTitle>
            <CardDescription>
              The unsustainable imbalance between value extracted and compensation paid
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              <div>
                <div className="flex justify-between text-sm mb-2">
                  <span>Content Creators Affected</span>
                  <span className="font-medium">2.8B+</span>
                </div>
                <Progress value={100} className="h-3" />
                <p className="text-xs text-muted-foreground mt-1">
                  Artists, writers, photographers, developers, musicians
                </p>
              </div>
              
              <div>
                <div className="flex justify-between text-sm mb-2">
                  <span>Attribution Given</span>
                  <span className="font-medium text-destructive">0%</span>
                </div>
                <Progress value={0} className="h-3" />
                <p className="text-xs text-muted-foreground mt-1">
                  No recognition or credit provided to original creators
                </p>
              </div>
              
              <div>
                <div className="flex justify-between text-sm mb-2">
                  <span>Compensation Paid</span>
                  <span className="font-medium text-destructive">$0</span>
                </div>
                <Progress value={0} className="h-3" />
                <p className="text-xs text-muted-foreground mt-1">
                  Zero financial compensation despite billions in profits
                </p>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>The Unsustainable Cycle</CardTitle>
            <CardDescription>
              How the current model creates long-term problems
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              <div className="flex items-start gap-3">
                <div className="h-8 w-8 rounded-full bg-destructive/20 flex items-center justify-center flex-shrink-0">
                  <span className="text-destructive font-semibold text-sm">1</span>
                </div>
                <div>
                  <h4 className="font-medium text-sm">Creator Disincentivization</h4>
                  <p className="text-xs text-muted-foreground">
                    Why create content if AI companies profit without compensation?
                  </p>
                </div>
              </div>
              
              <div className="flex items-start gap-3">
                <div className="h-8 w-8 rounded-full bg-destructive/20 flex items-center justify-center flex-shrink-0">
                  <span className="text-destructive font-semibold text-sm">2</span>
                </div>
                <div>
                  <h4 className="font-medium text-sm">Quality Degradation</h4>
                  <p className="text-xs text-muted-foreground">
                    Reduced incentives lead to lower quality human-created content
                  </p>
                </div>
              </div>
              
              <div className="flex items-start gap-3">
                <div className="h-8 w-8 rounded-full bg-destructive/20 flex items-center justify-center flex-shrink-0">
                  <span className="text-destructive font-semibold text-sm">3</span>
                </div>
                <div>
                  <h4 className="font-medium text-sm">Rising Resentment</h4>
                  <p className="text-xs text-muted-foreground">
                    Public backlash grows as the imbalance becomes more apparent
                  </p>
                </div>
              </div>
              
              <div className="flex items-start gap-3">
                <div className="h-8 w-8 rounded-full bg-primary/20 flex items-center justify-center flex-shrink-0">
                  <span className="text-primary font-semibold text-sm">?</span>
                </div>
                <div>
                  <h4 className="font-medium text-sm">Solution Needed</h4>
                  <p className="text-xs text-muted-foreground">
                    A fair system for automatic attribution and compensation
                  </p>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Current Attempts at Solutions */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <AlertTriangle className="h-5 w-5 text-amber-500" />
            Current Attempts at Solutions (And Why They&apos;re Failing)
          </CardTitle>
          <CardDescription>
            Various approaches being tried to address data exploitation, but they don&apos;t solve the fundamental economics
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div className="grid gap-4">
            <div className="p-4 border rounded-lg bg-red-50 border-red-200">
              <div className="flex items-center justify-between mb-2">
                <h4 className="font-semibold text-red-800">Legal Approaches</h4>
                <Badge variant="destructive" className="text-xs">25% Effective</Badge>
              </div>
              <p className="text-sm text-red-700 mb-2">EU AI Act, California SB-1001 requiring training data disclosure</p>
              <div className="text-xs text-red-600">
                <strong>Problems:</strong> Jurisdictional limits, slow enforcement, reactive only
              </div>
            </div>

            <div className="p-4 border rounded-lg bg-orange-50 border-orange-200">
              <div className="flex items-center justify-between mb-2">
                <h4 className="font-semibold text-orange-800">Technical Poisoning</h4>
                <Badge variant="secondary" className="text-xs">35% Effective</Badge>
              </div>
              <p className="text-sm text-orange-700 mb-2">Glaze/Nightshade tools to make data unusable for training</p>
              <div className="text-xs text-orange-600">
                <strong>Problems:</strong> Circumventable, damages legitimate use, creates arms race
              </div>
            </div>

            <div className="p-4 border rounded-lg bg-yellow-50 border-yellow-200">
              <div className="flex items-center justify-between mb-2">
                <h4 className="font-semibold text-yellow-800">Corporate Licensing</h4>
                <Badge variant="outline" className="text-xs">45% Effective</Badge>
              </div>
              <p className="text-sm text-yellow-700 mb-2">Getty Images, Shutterstock making deals with AI companies</p>
              <div className="text-xs text-yellow-600">
                <strong>Problems:</strong> Only benefits large content owners, excludes individual creators
              </div>
            </div>

            <div className="p-4 border rounded-lg bg-red-50 border-red-200">
              <div className="flex items-center justify-between mb-2">
                <h4 className="font-semibold text-red-800">Opt-out Mechanisms</h4>
                <Badge variant="destructive" className="text-xs">15% Effective</Badge>
              </div>
              <p className="text-sm text-red-700 mb-2">robots.txt, AI crawling blocks, &quot;Do Not Train&quot; requests</p>
              <div className="text-xs text-red-600">
                <strong>Problems:</strong> Voluntary compliance, easily ignored, no enforcement mechanism
              </div>
            </div>
          </div>

          <div className="mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
            <h4 className="font-semibold text-green-800 mb-2 flex items-center gap-2">
              <Database className="h-4 w-4" />
              What&apos;s Missing: Economic Infrastructure
            </h4>
            <p className="text-sm text-green-700">
              All current approaches fail because they don&apos;t address the fundamental economics. 
              We need automatic, micro-scale compensation that makes it economically rational 
              for AI companies to pay creators fairly for their data.
            </p>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}